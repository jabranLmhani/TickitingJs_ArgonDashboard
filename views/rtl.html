<!--
=========================================================
* Argon Dashboard 2 - v2.0.4
=========================================================

* Product Page: https://www.creative-tim.com/product/argon-dashboard
* Copyright 2022 Creative Tim (https://www.creative-tim.com)
* Licensed under MIT (https://www.creative-tim.com/license)
* Coded by Creative Tim

=========================================================

* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <title>
    Dashboard
  </title>
  
  <!-- Fonts and icons -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  
  <!-- Nucleo Icons -->
  <link href="/css/nucleo-icons.css" rel="stylesheet" />
  <link href="/css/nucleo-svg.css" rel="stylesheet" />
  
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  
  <!-- CSS Files -->
  <link id="pagestyle" href="/css/argon-dashboard.css?v=2.0.4" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="g-sidenav-show   bg-gray-100">
  <div class="min-height-300 bg-primary position-absolute w-100"></div>
  <aside class="sidenav bg-white navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-4 " id="sidenav-main">
    <div class="sidenav-header">
      <i class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none" aria-hidden="true" id="iconSidenav"></i>
      <a class="navbar-brand m-0" href=" https://demos.creative-tim.com/argon-dashboard/pages/dashboard.html " target="_blank">
        <img src="../img/logo-pluriel.png" class="navbar-brand-img h-100" alt="main_logo">
        <span class="ms-1 font-weight-bold">Admin Dashboard</span>
      </a>
    </div>
    <hr class="horizontal dark mt-0">
    <div class="collapse navbar-collapse  w-auto " id="sidenav-collapse-main">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link " href="../dashboard">
            <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="ni ni-tv-2 text-primary text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1">Dashboard</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="../tables">
            <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="ni ni-calendar-grid-58 text-warning text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1">Users</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="../billing">
            <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="ni ni-credit-card text-success text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1">Clients</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="../virtual-reality">
            <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="ni ni-app text-info text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1">Demandeurs</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="../rtl">
            <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="ni ni-world-2 text-danger text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1">Tickets</span>
          </a>
        </li>
        <li class="nav-item mt-3">
          <br><br>
          <h6 class="ps-4 ms-2 text-uppercase text-xs font-weight-bolder opacity-6">Account pages</h6>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="../profile">
            <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="ni ni-single-02 text-dark text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1">Profile</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="../sign-in">
            <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="ni ni-single-copy-04 text-warning text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1">Sign In</span>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="../sign-up">
            <div class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center">
              <i class="ni ni-collection text-info text-sm opacity-10"></i>
            </div>
            <span class="nav-link-text ms-1">LogOut</span>
          </a>
        </li>
      </ul>
    </div>
   
  </aside>
  <main class="main-content position-relative border-radius-lg ">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl " id="navbarBlur" data-scroll="false">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm"><a class="opacity-5 text-white" href="javascript:;">Pages</a></li>
            <li class="breadcrumb-item text-sm text-white active" aria-current="page">Tables</li>
          </ol>
          <h6 class="font-weight-bolder text-white mb-0">Tables</h6>
        </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
          <div class="ms-md-auto pe-md-3 d-flex align-items-center">
            <div class="input-group">
              <span class="input-group-text text-body"><i class="fas fa-search" aria-hidden="true"></i></span>
              <input type="text" class="form-control" placeholder="Type here...">
            </div>
          </div>
          <ul class="navbar-nav  justify-content-end">
            <li class="nav-item d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white font-weight-bold px-0">
                <i class="fa fa-user me-sm-1"></i>
                <span class="d-sm-inline d-none">Sign In</span>
              </a>
            </li>
            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                  <i class="sidenav-toggler-line bg-white"></i>
                </div>
              </a>
            </li>
            <li class="nav-item px-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0">
                <i class="fa fa-cog fixed-plugin-button-nav cursor-pointer"></i>
              </a>
            </li>
            <li class="nav-item dropdown pe-2 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-white p-0" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fa fa-bell cursor-pointer"></i>
              </a>
              <ul class="dropdown-menu  dropdown-menu-end  px-2 py-3 me-sm-n4" aria-labelledby="dropdownMenuButton">
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="my-auto">
                        <img src="../img/team-2.jpg" class="avatar avatar-sm  me-3 ">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          <span class="font-weight-bold">New message</span> from Laur
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          13 minutes ago
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
                <li class="mb-2">
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="my-auto">
                        <img src="../img/small-logos/logo-spotify.svg" class="avatar avatar-sm bg-gradient-dark  me-3 ">
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          <span class="font-weight-bold">New album</span> by Travis Scott
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          1 day
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
                <li>
                  <a class="dropdown-item border-radius-md" href="javascript:;">
                    <div class="d-flex py-1">
                      <div class="avatar avatar-sm bg-gradient-secondary  me-3  my-auto">
                        <svg width="12px" height="12px" viewBox="0 0 43 36" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                          <title>credit-card</title>
                          <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                            <g transform="translate(-2169.000000, -745.000000)" fill="#FFFFFF" fill-rule="nonzero">
                              <g transform="translate(1716.000000, 291.000000)">
                                <g transform="translate(453.000000, 454.000000)">
                                  <path class="color-background" d="M43,10.7482083 L43,3.58333333 C43,1.60354167 41.3964583,0 39.4166667,0 L3.58333333,0 C1.60354167,0 0,1.60354167 0,3.58333333 L0,10.7482083 L43,10.7482083 Z" opacity="0.593633743"></path>
                                  <path class="color-background" d="M0,16.125 L0,32.25 C0,34.2297917 1.60354167,35.8333333 3.58333333,35.8333333 L39.4166667,35.8333333 C41.3964583,35.8333333 43,34.2297917 43,32.25 L43,16.125 L0,16.125 Z M19.7083333,26.875 L7.16666667,26.875 L7.16666667,23.2916667 L19.7083333,23.2916667 L19.7083333,26.875 Z M35.8333333,26.875 L28.6666667,26.875 L28.6666667,23.2916667 L35.8333333,23.2916667 L35.8333333,26.875 Z"></path>
                                </g>
                              </g>
                            </g>
                          </g>
                        </svg>
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="text-sm font-weight-normal mb-1">
                          Payment successfully completed
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          <i class="fa fa-clock me-1"></i>
                          2 days
                        </p>
                      </div>
                    </div>
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!-- End Navbar -->
     















   
    <div class="container-fluid py-4">
        <div class="row mb-3">
            <div class="col-md-12">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newTicketModal">Add New Ticket</button>
                <button id="bulkDeleteButton" class="btn btn-danger">Delete Selected Tickets</button>
            </div>
        </div>
        <br><br><br>
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header pb-0">
                        <h6>Tickets Table</h6>
                    </div>
                    <div class="card-body px-0 pt-0 pb-2">
                        <div class="table-responsive p-0">
                            <table id="ticketTable" class="table align-items-center mb-0">
                                <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAllCheckbox"></th> <!-- Select all checkbox -->
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Title</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Description</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Status</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Client</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Demandeur</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Utilisateur</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Type</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Status</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Priorité</th>



                                    <th class="text-secondary opacity-7">Actions</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- Data will be dynamically inserted here -->
                                </tbody>
                            </table>
    
                           <!-- Modal for editing ticket -->
<div class="modal fade" id="editTicketModal" tabindex="-1" aria-labelledby="editTicketModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="editTicketModalLabel">Edit Ticket</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form id="editTicketForm">
                  <input type="hidden" id="editTicketId">
                  <div class="mb-3">
                      <label for="editTicketTitle" class="form-label">Title</label>
                      <input type="text" class="form-control" id="editTicketTitle" required>
                  </div>
                  <div class="mb-3">
                      <label for="editTicketDescription" class="form-label">Description</label>
                      <input type="text" class="form-control" id="editTicketDescription">
                  </div>
                  <div class="mb-3">
                      <label for="editTicketStatus" class="form-label">Status</label>
                      <select id="editTicketStatus" class="form-select">
                          <option value="en attente">En Attente</option>
                          <option value="en cours">En Cours</option>
                          <option value="resolu">Résolu</option>
                          <option value="rejeté">Rejeté</option>
                          <option value="necessite intervention">Nécessite Intervention</option>
                      </select>
                  </div>
                  <div class="mb-3">
                      <label for="editTicketType" class="form-label">Type</label>
                      <select id="editTicketType" class="form-select">
                          <option value="logiciel">Logiciel</option>
                          <option value="technique">Technique</option>
                      </select>
                  </div>
                  <div class="mb-3">
                      <label for="editTicketPriorite" class="form-label">Priorité</label>
                      <select id="editTicketPriorite" class="form-select">
                          <option value="haute">Haute</option>
                          <option value="moyenne">Moyenne</option>
                          <option value="basse">Basse</option>
                      </select>
                  </div>
                  <div class="mb-3">
                      <label for="editClientDropdown" class="form-label">Client</label>
                      <select id="editClientDropdown" class="form-select" required>
                          <!-- Options will be populated by JavaScript -->
                      </select>
                  </div>
                  <div class="mb-3">
                      <label for="editDemandeurDropdown" class="form-label">Demandeur</label>
                      <select id="editDemandeurDropdown" class="form-select" required>
                          <!-- Options will be populated by JavaScript -->
                      </select>
                  </div>
                  <div class="mb-3">
                      <label for="editUtilisateurDropdown" class="form-label">Utilisateur</label>
                      <select id="editUtilisateurDropdown" class="form-select" required>
                          <!-- Options will be populated by JavaScript -->
                      </select>
                  </div>
                  <button type="submit" class="btn btn-primary">Update Ticket</button>
              </form>
          </div>
      </div>
  </div>
</div>

<!-- Modal for creating new ticket -->
<div class="modal fade" id="newTicketModal" tabindex="-1" aria-labelledby="newTicketModalLabel" aria-hidden="true">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="newTicketModalLabel">Create New Ticket</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
              <form id="newTicketForm">
                  <div class="mb-3">
                      <label for="newTicketTitle" class="form-label">Title</label>
                      <input type="text" class="form-control" id="newTicketTitle" required>
                  </div>
                  <div class="mb-3">
                      <label for="newTicketDescription" class="form-label">Description</label>
                      <input type="text" class="form-control" id="newTicketDescription">
                  </div>
                  <div class="mb-3">
                      <label for="newTicketStatus" class="form-label">Status</label>
                      <select id="newTicketStatus" class="form-select">
                          <option value="en attente">En Attente</option>
                          <option value="en cours">En Cours</option>
                          <option value="resolu">Résolu</option>
                          <option value="rejeté">Rejeté</option>
                          <option value="necessite intervention">Nécessite Intervention</option>
                      </select>
                  </div>
                  <div class="mb-3">
                      <label for="newTicketType" class="form-label">Type</label>
                      <select id="newTicketType" class="form-select">
                          <option value="logiciel">Logiciel</option>
                          <option value="technique">Technique</option>
                      </select>
                  </div>
                  <div class="mb-3">
                      <label for="newTicketPriorite" class="form-label">Priorité</label>
                      <select id="newTicketPriorite" class="form-select">
                          <option value="haute">Haute</option>
                          <option value="moyenne">Moyenne</option>
                          <option value="basse">Basse</option>
                      </select>
                  </div>
                  <div class="mb-3">
                      <label for="newTicketClient" class="form-label">Client</label>
                      <select id="newTicketClient" class="form-select" required>
                          <!-- Options will be populated by JavaScript -->
                      </select>
                  </div>
                  <div class="mb-3">
                      <label for="newTicketDemandeur" class="form-label">Demandeur</label>
                      <select id="newTicketDemandeur" class="form-select" required>
                          <!-- Options will be populated by JavaScript -->
                      </select>
                  </div>
                  <div class="mb-3">
                      <label for="newTicketUtilisateur" class="form-label">Utilisateur</label>
                      <select id="newTicketUtilisateur" class="form-select" required>
                          <!-- Options will be populated by JavaScript -->
                      </select>
                  </div>
                  <button type="submit" class="btn btn-primary">Create Ticket</button>
              </form>
          </div>
      </div>
  </div>
</div>


              </div>
            </div>
          </div>
        </div>
      </div>
     
     
    </div>
  </main>
  <div class="fixed-plugin">
    <a class="fixed-plugin-button text-dark position-fixed px-3 py-2">
      <i class="fa fa-cog py-2"> </i>
    </a>
    <div class="card shadow-lg">
      <div class="card-header pb-0 pt-3 ">
        <div class="float-start">
          <h5 class="mt-3 mb-0">Argon Configurator</h5>
          <p>See our dashboard options.</p>
        </div>
        <div class="float-end mt-4">
          <button class="btn btn-link text-dark p-0 fixed-plugin-close-button">
            <i class="fa fa-close"></i>
          </button>
        </div>
        <!-- End Toggle Button -->
      </div>
      <hr class="horizontal dark my-1">
      <div class="card-body pt-sm-3 pt-0 overflow-auto">
        <!-- Sidebar Backgrounds -->
        <div>
          <h6 class="mb-0">Sidebar Colors</h6>
        </div>
        <a href="javascript:void(0)" class="switch-trigger background-color">
          <div class="badge-colors my-2 text-start">
            <span class="badge filter bg-gradient-primary active" data-color="primary" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-dark" data-color="dark" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-info" data-color="info" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-success" data-color="success" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-warning" data-color="warning" onclick="sidebarColor(this)"></span>
            <span class="badge filter bg-gradient-danger" data-color="danger" onclick="sidebarColor(this)"></span>
          </div>
        </a>
        <!-- Sidenav Type -->
        <div class="mt-3">
          <h6 class="mb-0">Sidenav Type</h6>
          <p class="text-sm">Choose between 2 different sidenav types.</p>
        </div>
        <div class="d-flex">
          <button class="btn bg-gradient-primary w-100 px-3 mb-2 active me-2" data-class="bg-white" onclick="sidebarType(this)">White</button>
          <button class="btn bg-gradient-primary w-100 px-3 mb-2" data-class="bg-default" onclick="sidebarType(this)">Dark</button>
        </div>
        <p class="text-sm d-xl-none d-block mt-2">You can change the sidenav type just on desktop view.</p>
        <!-- Navbar Fixed -->
        <div class="d-flex my-3">
          <h6 class="mb-0">Navbar Fixed</h6>
          <div class="form-check form-switch ps-0 ms-auto my-auto">
            <input class="form-check-input mt-1 ms-auto" type="checkbox" id="navbarFixed" onclick="navbarFixed(this)">
          </div>
        </div>
        <hr class="horizontal dark my-sm-4">
        <div class="mt-2 mb-5 d-flex">
          <h6 class="mb-0">Light / Dark</h6>
          <div class="form-check form-switch ps-0 ms-auto my-auto">
            <input class="form-check-input mt-1 ms-auto" type="checkbox" id="dark-version" onclick="darkMode(this)">
          </div>
        </div>
        <a class="btn bg-gradient-dark w-100" href="https://www.creative-tim.com/product/argon-dashboard">Free Download</a>
        <a class="btn btn-outline-dark w-100" href="https://www.creative-tim.com/learning-lab/bootstrap/license/argon-dashboard">View documentation</a>
        <div class="w-100 text-center">
          <a class="github-button" href="https://github.com/creativetimofficial/argon-dashboard" data-icon="octicon-star" data-size="large" data-show-count="true" aria-label="Star creativetimofficial/argon-dashboard on GitHub">Star</a>
          <h6 class="mt-3">Thank you for sharing!</h6>
          <a href="https://twitter.com/intent/tweet?text=Check%20Argon%20Dashboard%20made%20by%20%40CreativeTim%20%23webdesign%20%23dashboard%20%23bootstrap5&amp;url=https%3A%2F%2Fwww.creative-tim.com%2Fproduct%2Fargon-dashboard" class="btn btn-dark mb-0 me-2" target="_blank">
            <i class="fab fa-twitter me-1" aria-hidden="true"></i> Tweet
          </a>
          <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.creative-tim.com/product/argon-dashboard" class="btn btn-dark mb-0 me-2" target="_blank">
            <i class="fab fa-facebook-square me-1" aria-hidden="true"></i> Share
          </a>
        </div>
      </div>
    </div>
  </div>
  <!--   Core JS Files   -->
  <script>
    let token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVc2VySW5mbyI6eyJ1c2VybmFtZSI6ImFsOCIsInJvbGVzIjpbMjAwMSw1MTUwXX0sImlhdCI6MTcyNDA5MzA3NX0.Xzvj2wb_tdGQBkWODmNFJGv7eZ8OoqfNnWGRCzMMnrs'; // Define token globally

document.addEventListener('DOMContentLoaded', () => {
    fetchTickets();
    fetchClientsForDropdown();
    fetchDemandeursForDropdown();
    fetchUtilisateursForDropdown();
});
// Function to handle editing a ticket
function editTicket(event) {
    const ticketId = event.target.getAttribute('data-id');

    // Fetch the ticket details and populate the edit form
    fetch(`/api/ticket/${ticketId}`, {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to fetch ticket details.');
        }
        return response.json();
    })
    .then(ticket => {
        // Populate the edit form with the ticket's data
        document.getElementById('editTicketId').value = ticket._id;
        document.getElementById('editTicketTitle').value = ticket.title;
        document.getElementById('editTicketDescription').value = ticket.description;
        document.getElementById('editTicketStatus').value = ticket.status;
        document.getElementById('editTicketType').value = ticket.type;
        document.getElementById('editTicketPriorite').value = ticket.priorite;
        document.getElementById('editClientDropdown').value = ticket.client?._id || '';
        document.getElementById('editDemandeurDropdown').value = ticket.demandeur?._id || '';
        document.getElementById('editUtilisateurDropdown').value = ticket.utilisateur?._id || '';

        // Show the edit modal
        showEditTicketModal();
    })
    .catch(error => {
        console.error('Error fetching ticket for editing:', error);
        alert('Failed to fetch ticket details for editing. Please try again.');
    });
}

// Function to show the edit ticket modal
function showEditTicketModal() {
    const editModal = new bootstrap.Modal(document.getElementById('editTicketModal'));
    editModal.show();
}

// Function to hide the edit ticket modal after submission
function hideEditTicketModal() {
    const editModal = new bootstrap.Modal(document.getElementById('editTicketModal'));
    editModal.hide();
}

// Fetch tickets and populate table
async function fetchTickets() {
    try {
        const response = await fetch('/api/ticket', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            console.error(`Fetch error: ${response.status} ${response.statusText}`);
            throw new Error('Network response was not ok');
        }

        // Check if response body is empty
        const text = await response.text();
        const tickets = text ? JSON.parse(text) : [];

        const tableBody = document.querySelector('#ticketTable tbody');
        tableBody.innerHTML = '';
        tickets.forEach(ticket => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="checkbox" name="ticketCheckbox" data-id="${ticket._id}"></td>
                <td>${ticket.title}</td>
                <td>${ticket.description}</td>
                <td>${ticket.status}</td>
                <td>${ticket.client ? ticket.client.nom : 'N/A'}</td>
                <td>${ticket.demandeur ? ticket.demandeur.nom : 'N/A'}</td>
                <td>${ticket.utilisateur ? ticket.utilisateur.username : 'N/A'}</td>
                <td>${ticket.type}</td>
                <td>${ticket.etat}</td>
                <td>${ticket.priorite}</td>
                <td>
                    <button class="btn btn-warning btn-sm edit-btn" data-id="${ticket._id}">Edit</button>
                    <button class="btn btn-danger btn-sm delete-btn" data-id="${ticket._id}">Delete</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
        attachEventListeners();
    } catch (error) {
        console.error('Error fetching tickets:', error);
    }
}


const fetchUtilisateursForDropdown = async () => {
    try {
        const response = await fetch('/user', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const utilisateurs = await response.json();
        
        // Populate both dropdowns
        const editDropdown = document.querySelector('#editUtilisateurDropdown');
        const newDropdown = document.querySelector('#newTicketUtilisateur');
        
        if (!editDropdown || !newDropdown) {
            console.error('Dropdown elements for utilisateurs not found');
            return;
        }
        
        [editDropdown, newDropdown].forEach(dropdown => {
            dropdown.innerHTML = '<option value="">Select an utilisateur</option>';
            utilisateurs.forEach(utilisateur => {
                const option = document.createElement('option');
                option.value = utilisateur._id;
                option.textContent = utilisateur.username; // Display the username in the dropdown
                dropdown.appendChild(option);
            });
        });
    } catch (error) {
        console.error('Error fetching utilisateurs:', error);
    }
};

// Fetch clients for dropdown
async function fetchClientsForDropdown(query = '') {
    try {
        const response = await fetch(`/client?search=${encodeURIComponent(query)}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const clients = await response.json();
        const editDropdown = document.querySelector('#editClientDropdown');
        const newDropdown = document.querySelector('#newTicketClient');
        if (!editDropdown || !newDropdown) {
            console.error('Dropdown element not found');
            return;
        }
        [editDropdown, newDropdown].forEach(dropdown => {
            dropdown.innerHTML = '<option value="">Select a client</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client._id;
                option.textContent = client.nom;
                dropdown.appendChild(option);
            });
        });
    } catch (error) {
        console.error('Error fetching clients:', error);
    }
}
const fetchDemandeursForDropdown = async () => {
    try {
        const response = await fetch(`/api/demandeur`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        const demandeurs = await response.json();
        
        // Populate both dropdowns
        const editDropdown = document.querySelector('#editDemandeurDropdown');
        const newDropdown = document.querySelector('#newTicketDemandeur');
        
        if (!editDropdown || !newDropdown) {
            console.error('Dropdown elements for demandeurs not found');
            return;
        }
        
        [editDropdown, newDropdown].forEach(dropdown => {
            dropdown.innerHTML = '<option value="">Select a demandeur</option>';
            demandeurs.forEach(demandeur => {
                const option = document.createElement('option');
                option.value = demandeur._id;
                option.textContent = demandeur.nom;
                dropdown.appendChild(option);
            });
        });
    } catch (error) {
        console.error('Error fetching demandeurs:', error);
    }
};



// Attach event listeners to buttons
function attachEventListeners() {
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', editTicket);
    });

    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', deleteTicket);
    });

    document.querySelectorAll('input[name="ticketCheckbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', event => {
            const ticketId = event.currentTarget.getAttribute('data-id');
            console.log(`Checkbox for ticket with ID: ${ticketId} changed`);
        });
    });

    const editForm = document.getElementById('editTicketForm');
    const newForm = document.getElementById('newTicketForm');
    if (editForm) {
        editForm.addEventListener('submit', handleEditTicketFormSubmit);
    } else {
        console.error('Edit ticket form not found');
    }
    if (newForm) {
        newForm.addEventListener('submit', handleNewTicketFormSubmit);
    } else {
        console.error('New ticket form not found');
    }
    document.getElementById('selectAllCheckbox')?.addEventListener('change', toggleSelectAllCheckboxes);
    document.getElementById('bulkDeleteButton')?.addEventListener('click', deleteSelectedTickets);
}


// Handle delete ticket
async function deleteTicket(event) {
    const ticketId = event.target.getAttribute('data-id');
    if (!ticketId) {
        alert('L\'ID du ticket est manquant. Impossible de supprimer le ticket.');
        return;
    }

    if (confirm(`Êtes-vous sûr de vouloir supprimer le ticket avec l'ID ${ticketId} ?`)) {
        try {
            const response = await fetch(`/api/ticket/${ticketId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ id: ticketId }) // Sending the ID in the request body
            });

            
            fetchTickets(); // Refresh the list of tickets
        } catch (error) {
            console.error('Erreur lors de la suppression du ticket :', error.message);
            alert('Échec de la suppression du ticket. Veuillez consulter la console pour plus de détails.');
        }
    }
}


// Handle edit ticket form submission
function handleEditTicketFormSubmit(event) {
    event.preventDefault();

    // Collect the form data
    const ticketIdElement = document.getElementById('editTicketId');
    const ticketTitleElement = document.getElementById('editTicketTitle');
    const ticketDescriptionElement = document.getElementById('editTicketDescription');
    const ticketStatusElement = document.getElementById('editTicketStatus');
    const ticketTypeElement = document.getElementById('editTicketType');
    const ticketPrioriteElement = document.getElementById('editTicketPriorite');
    const clientDropdownElement = document.getElementById('editClientDropdown');
    const demandeurDropdownElement = document.getElementById('editDemandeurDropdown');
    const utilisateurDropdownElement = document.getElementById('editUtilisateurDropdown');

    // Check if elements exist
    if (!ticketIdElement || !ticketTitleElement || !ticketDescriptionElement ||
        !ticketStatusElement || !ticketTypeElement || !ticketPrioriteElement ||
        !clientDropdownElement || !demandeurDropdownElement || !utilisateurDropdownElement) {
        console.error('One or more form elements are missing.');
        alert('There was an issue with the form. Please try again.');
        return;
    }

    // Proceed with submission if all elements are found
    const ticketData = {
        id: ticketIdElement.value,
        title: ticketTitleElement.value,
        description: ticketDescriptionElement.value,
        status: ticketStatusElement.value,
        type: ticketTypeElement.value,
        priorite: ticketPrioriteElement.value,
        client: clientDropdownElement.value,
        demandeur: demandeurDropdownElement.value,
        utilisateur: utilisateurDropdownElement.value,
    };

    // Send the update request
    fetch(`/api/ticket/${ticketData.id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(ticketData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                throw new Error(`Failed to update ticket: ${error.message}`);
            });
        }
        return response.json();
    })
   
    .catch(error => {
        console.error('Error updating ticket:', error.message);
        alert('Failed to update ticket. Please check the console for more details.');
    });
}
function closeEditTicketModal() {
    // Assuming you are using Bootstrap for the modal, you can use this:
    const modal = document.getElementById('editTicketModal'); // Adjust the ID to match your modal's ID
    const modalInstance = bootstrap.Modal.getInstance(modal);
    if (modalInstance) {
        modalInstance.hide();
    } else {
        console.error('No modal instance found.');
    }
}




// Handle new ticket form submission
async function handleNewTicketFormSubmit(event) {
    event.preventDefault();
    
    // Fetch elements and handle null cases
    const titleInput = document.getElementById('newTicketTitle');
    const descriptionInput = document.getElementById('newTicketDescription');
    const clientDropdown = document.getElementById('newTicketClient');
    const demandeurDropdown = document.getElementById('newTicketDemandeur');
    const utilisateurDropdown = document.getElementById('newTicketUtilisateur');
    const statusDropdown = document.getElementById('newTicketStatus');
    const typeDropdown = document.getElementById('newTicketType');
    const prioriteDropdown = document.getElementById('newTicketPriorite');
    
    if (!titleInput || !descriptionInput || !clientDropdown || !demandeurDropdown || !utilisateurDropdown ||
        !statusDropdown || !typeDropdown || !prioriteDropdown) {
        console.error('One or more form elements are missing');
        return;
    }

    const newTicket = {
        title: titleInput.value,
        description: descriptionInput.value,
        client: clientDropdown.value,
        demandeur: demandeurDropdown.value,
        utilisateur: utilisateurDropdown.value,
        status: statusDropdown.value,
        type: typeDropdown.value,
        priorite: prioriteDropdown.value
    };

    try {
        const response = await fetch('/api/ticket', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`, // Ensure `token` is defined
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newTicket)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to create ticket: ${errorText}`);
        }

        // Fetch tickets again to update the UI
        fetchTickets();
        hideNewTicketModal(); // Ensure this function hides the modal
    } catch (error) {
        console.error('Error creating ticket:', error.message);
        alert('Failed to create ticket. Please check the console for more details.');
    }
}

function hideNewTicketModal() {
    // Assuming you are using Bootstrap for the modal, you can use this:
    const modal = document.getElementById('newTicketModal'); // Adjust the ID to match your modal's ID
    const modalInstance = bootstrap.Modal.getInstance(modal);
    if (modalInstance) {
        modalInstance.hide();
    } else {
        console.error('No modal instance found.');
    }
}

// Function to toggle all checkboxes
function toggleSelectAllCheckboxes(event) {
    const isChecked = event.target.checked;
    document.querySelectorAll('input[name="ticketCheckbox"]').forEach(checkbox => {
        checkbox.checked = isChecked;
    });
}

// Function to delete selected tickets
async function deleteSelectedTickets() {
    const selectedIds = Array.from(document.querySelectorAll('input[name="ticketCheckbox"]:checked'))
        .map(checkbox => checkbox.getAttribute('data-id'));
    if (selectedIds.length === 0) {
        alert('No tickets selected');
        return;
    }
    if (confirm(`Are you sure you want to delete ${selectedIds.length} tickets?`)) {
        try {
            const response = await fetch('/api/ticket/bulk-delete', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ids: selectedIds })
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Failed to delete tickets: ${errorText}`);
            }
            fetchTickets();
        } catch (error) {
            console.error('Error deleting tickets:', error.message);
            alert('Failed to delete tickets. Please check the console for more details.');
        }
    }
}

  </script>
    

    
  <script src="/js/core/popper.min.js"></script>
  <script src="/js/core/bootstrap.min.js"></script>
  <script src="/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="/js/plugins/chartjs.min.js"></script>
  <script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="/js/argon-dashboard.min.js?v=2.0.4"></script>
</body>

</html>